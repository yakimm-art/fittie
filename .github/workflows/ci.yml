name: Fittie CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping npm install"
          fi
      
      - name: Run ESLint
        run: |
          if [ -f package.json ] && grep -q "eslint" package.json; then
            npm run lint
          else
            echo "ESLint not configured, skipping"
          fi
        continue-on-error: true
      
      - name: Run Prettier check
        run: |
          if [ -f package.json ] && grep -q "prettier" package.json; then
            npm run format:check
          else
            echo "Prettier not configured, skipping"
          fi
        continue-on-error: true

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install backend dependencies
        run: |
          if [ -d backend ] && [ -f backend/package.json ]; then
            cd backend
            npm ci
          else
            echo "No backend package.json found, skipping"
          fi
      
      - name: Run backend tests
        run: |
          if [ -d backend ] && [ -f backend/package.json ]; then
            cd backend
            npm test
          else
            echo "No backend tests found, skipping"
          fi
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
        continue-on-error: true

  test-scripts:
    name: Test Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
      
      - name: Check script syntax
        run: |
          for script in scripts/*.sh; do
            echo "Checking $script"
            bash -n "$script" || exit 1
          done
      
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
        continue-on-error: true

  validate-infra:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install AWS CDK
        run: npm install -g aws-cdk
      
      - name: Validate CDK
        run: |
          if [ -d infra ] && [ -f infra/package.json ]; then
            cd infra
            npm ci
            cdk synth
          else
            echo "No infrastructure code found, skipping"
          fi
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [lint, test-backend, test-scripts, validate-infra, security-scan]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Backend Tests: ${{ needs.test-backend.result }}"
          echo "Script Tests: ${{ needs.test-scripts.result }}"
          echo "Infrastructure: ${{ needs.validate-infra.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          
          if [ "${{ needs.test-scripts.result }}" == "failure" ]; then
            echo "Critical: Script tests failed"
            exit 1
          fi
          
          echo "Build completed"
